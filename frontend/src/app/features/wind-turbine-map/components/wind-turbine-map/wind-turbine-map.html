<div class="map-page-layout">
  
  @if (!isSidebarVisible()) {
  <div class="map-controls-top">
    <button type="button" class="control-btn filter-btn" (click)="toggleSidebar()">
      <span>&#9776;</span> {{ 'MAP.CONTROLS.FILTERS' | translate }}
    </button>
    
    <button type="button" class="control-btn add-btn" (click)="openAddTurbineModal()">
      <span>&#43;</span> {{ 'MAP.CONTROLS.ADD_TURBINE' | translate }}
    </button>
  </div>
  }

  <button type="button" class="weather-toggle-btn" (click)="weatherPanel.toggleVisibility()">
    <span>☁️</span> {{ 'MAP.CONTROLS.WEATHER' | translate }}
  </button>

  <app-weather-panel-component #weatherPanel (weatherChanged)="onWeatherUpdate($event)" />

  <aside class="sidebar-left" [class.hidden]="!isSidebarVisible()">
    
    <div class="sidebar-header">
      <h2 class="sidebar-title">{{ 'MAP.SIDEBAR.TITLE' | translate }}</h2>
      <button type="button" class="close-sidebar-btn" (click)="toggleSidebar()">
        &#10005;
      </button>
    </div>

    <div class="sidebar-content">
      
      <form [formGroup]="filterForm" class="filters-container">
        
        <div class="filter-group">
          <label>{{ 'MODAL.PRODUCT_ID' | translate }}</label>
          <input type="text" formControlName="productId" [placeholder]="'MODAL.PLACEHOLDERS.PRODUCT_ID' | translate" class="filter-input">
        </div>

        <div class="filter-group">
          <label>{{ 'FILTERS.TYPE' | translate }}</label>
          <select formControlName="typeCode" class="filter-select">
            <option value="">{{ 'FILTERS.ALL_TYPES' | translate }}</option>
            <option value="L">{{ 'MODAL.TYPE_OPTIONS.LOW' | translate }}</option>
            <option value="M">{{ 'MODAL.TYPE_OPTIONS.MEDIUM' | translate }}</option>
            <option value="H">{{ 'MODAL.TYPE_OPTIONS.HIGH' | translate }}</option>
          </select>
        </div>

         <div class="filter-group">
          <label>{{ 'FILTERS.STATUS' | translate }}</label>
          <select formControlName="severity" class="filter-select">
            <option value="">{{ 'FILTERS.ALL_STATUSES' | translate }}</option>
            <option value="GOOD">{{ 'TURBINE.HEALTHY' | translate }}</option>
            <option value="CAUTION">{{ 'TURBINE.CAUTION' | translate }}</option>
            <option value="FAILURE">{{ 'TURBINE.FAILURE' | translate }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label>{{ 'FILTERS.CITY' | translate }}</label>
          <input type="text" formControlName="city" [placeholder]="'FILTERS.PLACEHOLDERS.CITY' | translate" class="filter-input">
        </div>

        <div class="filter-group">
          <label>{{ 'FILTERS.WEAR_RANGE' | translate }}</label>
          <div class="range-inputs">
            <input type="number" formControlName="minToolWear" [placeholder]="'FILTERS.PLACEHOLDERS.MIN' | translate" class="filter-input small">
            <span class="range-divider">-</span>
            <input type="number" formControlName="maxToolWear" [placeholder]="'FILTERS.PLACEHOLDERS.MAX' | translate" class="filter-input small">
          </div>
        </div>

        <div class="button-group">
          <button type="button" class="apply-btn" (click)="applyFilters()">{{ 'MAP.SIDEBAR.SEARCH' | translate }}</button>
          <button type="button" class="reset-btn" (click)="clearFilters()">{{ 'FILTERS.RESET' | translate }}</button>
        </div>
      </form>

      <div class="turbine-list-container">
        <p class="results-info">{{ 'MAP.SIDEBAR.RESULTS' | translate }}: <strong>{{ turbines().length }}</strong></p>
        <div class="scroll-area">
          @for (turbine of turbines(); track turbine.productId) {
            <div class="turbine-card">
              <div class="status-indicator" [class.true]="turbine.isActive" [class.false]="!turbine.isActive"></div>
              <div class="card-content">
                <span class="id">{{ turbine.productId }}</span>
                <span class="city">{{ turbine.city }} | {{ turbine.typeCode }}</span>
              </div>
              <div class="wear-info">{{ turbine.currentToolWear }}</div>
            </div>
          } @empty {
            <p class="no-results">{{ 'MAP.SIDEBAR.NO_RESULTS' | translate }}</p>
          }
        </div>
      </div>

      @if (isFiltering()) {
      <div class="pagination-container">
        <button type="button" class="page-nav-btn" (click)="prevPage()" [disabled]="pagination().page <= 1">
          &lsaquo;
        </button>

        <div class="page-numbers">
          @for (p of pageNumbers(); track p) {
            <button type="button" 
                    class="page-num" 
                    [class.active]="p === pagination().page"
                    (click)="goToPage(p)">
              {{ p }}
            </button>
          }
        </div>

        <button type="button" class="page-nav-btn" (click)="nextPage()" [disabled]="pagination().page >= totalPages()">
          &rsaquo;
        </button>
      </div>
      }
    </div>
  
  </aside>

  <div class="map-wrapper">
    <div id="map"></div>
  </div>

</div>